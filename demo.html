<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sully — WebSocket Streaming Demo</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">

    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg:         #080a14;
            --s1:         #0d1023;
            --s2:         #111428;
            --b1:         #1c2040;
            --b2:         #262c54;

            --teal:       #00cba8;
            --teal-glow:  rgba(0, 203, 168, 0.14);
            --teal-b:     rgba(0, 203, 168, 0.3);
            --red:        #ff3d6e;
            --red-glow:   rgba(255, 61, 110, 0.18);
            --red-b:      rgba(255, 61, 110, 0.35);
            --amber:      #ffb930;
            --amber-glow: rgba(255, 185, 48, 0.12);
            --amber-b:    rgba(255, 185, 48, 0.3);
            --blue:       #4d9fff;
            --blue-glow:  rgba(77, 159, 255, 0.1);

            --t1: #e4eaff;
            --t2: #9aa3cc;
            --t3: #5c6499;

            --ui:   'Syne', sans-serif;
            --mono: 'JetBrains Mono', monospace;
            --r:    12px;
        }

        html, body {
            height: 100%;
            background: var(--bg);
            color: var(--t1);
            font-family: var(--ui);
            -webkit-font-smoothing: antialiased;
        }

        body {
            background-image: radial-gradient(circle, rgba(255,255,255,0.025) 1px, transparent 1px);
            background-size: 28px 28px;
        }

        body::before {
            content: '';
            position: fixed;
            top: -200px;
            left: 50%;
            transform: translateX(-50%);
            width: 800px;
            height: 500px;
            background: radial-gradient(ellipse, rgba(0, 203, 168, 0.05) 0%, transparent 68%);
            pointer-events: none;
            z-index: 0;
        }

        /* ── App Shell ──────────────────────────────────────── */
        .app {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0 28px 48px;
            max-width: 1220px;
            margin: 0 auto;
        }

        /* ── Header ─────────────────────────────────────────── */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 22px 0 18px;
            border-bottom: 1px solid var(--b1);
            margin-bottom: 28px;
            gap: 16px;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .logo-img {
            width: 32px;
            height: 32px;
            object-fit: contain;
            border-radius: 6px;
        }

        .logo-word {
            font-size: 21px;
            font-weight: 800;
            letter-spacing: -0.5px;
            color: var(--t1);
        }

        .logo-accent { color: var(--teal); }

        .logo-sep {
            width: 1px;
            height: 18px;
            background: var(--b2);
        }

        .logo-sub {
            font-family: var(--mono);
            font-size: 10px;
            letter-spacing: 0.16em;
            text-transform: uppercase;
            color: var(--t3);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chip {
            font-family: var(--mono);
            font-size: 10px;
            letter-spacing: 0.07em;
            color: var(--t3);
            padding: 5px 11px;
            border: 1px solid var(--b1);
            border-radius: 100px;
            background: var(--s1);
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .chip.live { color: var(--t2); border-color: var(--b2); }

        .status-pill {
            display: flex;
            align-items: center;
            gap: 7px;
            padding: 6px 14px;
            border-radius: 100px;
            border: 1px solid var(--b1);
            background: var(--s1);
            font-family: var(--mono);
            font-size: 10px;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--t2);
            transition: all 0.25s ease;
            white-space: nowrap;
        }

        .s-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--t3);
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .status-pill.connected    { border-color: var(--teal-b); color: var(--teal); background: var(--teal-glow); }
        .status-pill.connected    .s-dot { background: var(--teal); box-shadow: 0 0 8px var(--teal); }
        .status-pill.connecting,
        .status-pill.starting,
        .status-pill.reconnecting { border-color: var(--amber-b); color: var(--amber); background: var(--amber-glow); }
        .status-pill.connecting   .s-dot,
        .status-pill.starting     .s-dot,
        .status-pill.reconnecting .s-dot { background: var(--amber); animation: blink 1s step-end infinite; }
        .status-pill.error        { border-color: var(--red-b); color: var(--red); background: var(--red-glow); }
        .status-pill.error        .s-dot { background: var(--red); }

        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.15; } }

        /* ── Main Grid ──────────────────────────────────────── */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 20px;
            flex: 1;
            min-height: 0;
        }

        .left-col  { display: flex; flex-direction: column; gap: 20px; }
        .right-col { display: flex; flex-direction: column; gap: 16px; }

        /* ── Panel base ─────────────────────────────────────── */
        .panel {
            background: var(--s1);
            border: 1px solid var(--b1);
            border-radius: var(--r);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            border-bottom: 1px solid var(--b1);
            background: var(--s2);
            flex-shrink: 0;
        }

        .panel-tag {
            font-family: var(--mono);
            font-size: 10px;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            color: var(--t3);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: var(--t3);
            transition: all 0.3s;
        }

        .panel-dot.on { background: var(--teal); box-shadow: 0 0 6px var(--teal); }

        .panel-info {
            font-family: var(--mono);
            font-size: 10px;
            color: var(--t3);
        }

        /* ── Record Section ─────────────────────────────────── */
        .record-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 22px;
            padding: 44px 24px 36px;
        }

        .btn-wrap {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ring {
            position: absolute;
            width: 112px;
            height: 112px;
            border-radius: 50%;
            border: 1px solid var(--red);
            opacity: 0;
            pointer-events: none;
        }

        .ring.pulse { animation: ring-out 2s ease-out infinite; }
        .ring:nth-child(2).pulse { animation-delay: 0.7s; }

        @keyframes ring-out {
            0%   { transform: scale(0.88); opacity: 0.45; }
            100% { transform: scale(1.9);  opacity: 0; }
        }

        .rec-btn {
            position: relative;
            width: 88px;
            height: 88px;
            border-radius: 50%;
            border: 1.5px solid var(--b2);
            background: var(--s2);
            color: var(--t1);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition:
                transform    0.22s cubic-bezier(0.34, 1.56, 0.64, 1),
                border-color 0.2s ease,
                background   0.2s ease,
                box-shadow   0.2s ease;
        }

        .rec-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: radial-gradient(circle, var(--teal-glow), transparent 70%);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .rec-btn:hover                { transform: scale(1.07); border-color: var(--teal); box-shadow: 0 0 28px var(--teal-glow); }
        .rec-btn:hover::before        { opacity: 1; }
        .rec-btn:active               { transform: scale(0.95); }
        .rec-btn.recording            { border-color: var(--red-b); background: var(--red-glow); box-shadow: 0 0 32px var(--red-glow); }
        .rec-btn.recording::before    { background: radial-gradient(circle, var(--red-glow), transparent 70%); opacity: 1; }
        .rec-btn.recording:hover      { border-color: var(--red); }

        .btn-ico { color: var(--t1); transition: color 0.2s; }
        .rec-btn.recording .btn-ico { color: var(--red); }

        .btn-lbl {
            font-family: var(--mono);
            font-size: 8px;
            letter-spacing: 0.22em;
            text-transform: uppercase;
            color: var(--t2);
            transition: color 0.2s;
        }

        .rec-btn.recording .btn-lbl { color: var(--red); }

        /* Waveform */
        .waveform {
            display: flex;
            align-items: center;
            gap: 3px;
            height: 22px;
            opacity: 0;
            transition: opacity 0.35s ease;
        }

        .waveform.on { opacity: 1; }

        .w-bar {
            width: 3px;
            background: var(--teal);
            border-radius: 2px;
            height: 3px;
            animation: wave-a 1.1s ease-in-out infinite;
        }

        .w-bar:nth-child(1) { animation-delay: 0.00s; }
        .w-bar:nth-child(2) { animation-delay: 0.12s; }
        .w-bar:nth-child(3) { animation-delay: 0.24s; }
        .w-bar:nth-child(4) { animation-delay: 0.36s; }
        .w-bar:nth-child(5) { animation-delay: 0.48s; }
        .w-bar:nth-child(6) { animation-delay: 0.36s; }
        .w-bar:nth-child(7) { animation-delay: 0.24s; }

        @keyframes wave-a { 0%, 100% { height: 3px; } 50% { height: 20px; } }

        .rec-hint {
            font-family: var(--mono);
            font-size: 11px;
            letter-spacing: 0.04em;
            color: var(--t3);
            text-align: center;
        }

        /* ── Transcript ──────────────────────────────────────── */
        .tx-body {
            flex: 1;
            padding: 24px 24px 28px;
            font-family: var(--mono);
            font-size: 14px;
            font-weight: 300;
            line-height: 1.95;
            color: var(--t1);
            min-height: 160px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .tx-placeholder {
            color: var(--t3);
            font-style: italic;
            font-size: 13px;
        }

        .cursor {
            display: inline-block;
            width: 2px;
            height: 1.1em;
            background: var(--teal);
            vertical-align: text-bottom;
            margin-left: 2px;
            animation: cursor-blink 1s step-end infinite;
        }

        @keyframes cursor-blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* ── Status History ─────────────────────────────────── */
        .history-body {
            max-height: 200px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--b2) transparent;
        }

        .history-body::-webkit-scrollbar       { width: 3px; }
        .history-body::-webkit-scrollbar-thumb { background: var(--b2); border-radius: 2px; }

        .h-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 9px 18px;
            border-bottom: 1px solid var(--b1);
            animation: slide-in 0.2s ease;
        }

        .h-row:last-child { border-bottom: none; }

        @keyframes slide-in {
            from { opacity: 0; transform: translateY(-5px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .h-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
            background: var(--t3);
        }

        .h-dot.connected    { background: var(--teal); box-shadow: 0 0 6px var(--teal); }
        .h-dot.connecting,
        .h-dot.starting,
        .h-dot.reconnecting { background: var(--amber); }
        .h-dot.error        { background: var(--red); }

        .h-label {
            font-family: var(--mono);
            font-size: 11px;
            color: var(--t2);
            flex: 1;
        }

        .h-ts {
            font-family: var(--mono);
            font-size: 10px;
            color: var(--t3);
        }

        .empty-state {
            padding: 20px 18px;
            font-family: var(--mono);
            font-size: 11px;
            color: var(--t3);
            font-style: italic;
        }

        /* ── Event Log ──────────────────────────────────────── */
        .event-panel { flex: 1; }

        .event-body {
            flex: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--b2) transparent;
            min-height: 180px;
            max-height: 340px;
        }

        .event-body::-webkit-scrollbar       { width: 3px; }
        .event-body::-webkit-scrollbar-thumb { background: var(--b2); border-radius: 2px; }

        .ev-row {
            padding: 9px 18px;
            border-bottom: 1px solid var(--b1);
            font-family: var(--mono);
            font-size: 11px;
            line-height: 1.55;
            animation: slide-in 0.2s ease;
        }

        .ev-row:last-child { border-bottom: none; }

        .ev-head {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .ev-tag {
            font-size: 9px;
            letter-spacing: 0.14em;
            text-transform: uppercase;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
        }

        .ev-tag.STATUS     { background: var(--amber-glow); color: var(--amber); }
        .ev-tag.TRANSCRIPT { background: var(--teal-glow);  color: var(--teal);  }
        .ev-tag.ERROR      { background: var(--red-glow);   color: var(--red);   }
        .ev-tag.COMPLETE   { background: var(--blue-glow);  color: var(--blue);  }

        .ev-ts { color: var(--t3); font-size: 10px; }

        .ev-data       { color: var(--t2); word-break: break-word; }
        .ev-data-em    { color: var(--t1); }
        .ev-data-aside { color: var(--t3); }

        .ev-empty {
            padding: 24px 18px;
            font-family: var(--mono);
            font-size: 11px;
            color: var(--t3);
            font-style: italic;
            text-align: center;
        }

        /* ── Footer ─────────────────────────────────────────── */
        .footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 0 0;
            border-top: 1px solid var(--b1);
            margin-top: 24px;
            font-family: var(--mono);
            font-size: 10px;
            color: var(--t3);
            letter-spacing: 0.07em;
            flex-wrap: wrap;
            gap: 8px;
        }

        /* ── Animations ─────────────────────────────────────── */
        @keyframes fade-up {
            from { opacity: 0; transform: translateY(14px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .header    { animation: fade-up 0.4s ease both; }
        .main-grid { animation: fade-up 0.4s ease 0.07s both; }
        .footer    { animation: fade-up 0.4s ease 0.14s both; }

        /* ── Responsive ─────────────────────────────────────── */
        @media (max-width: 900px) {
            .main-grid { grid-template-columns: 1fr; }
            .right-col { flex-direction: row; }
            .history-body { max-height: 160px; }
            .event-body   { min-height: 120px; max-height: 200px; }
        }

        @media (max-width: 600px) {
            .app { padding: 0 16px 32px; }
            .right-col { flex-direction: column; }
            .chip { display: none; }
        }
    </style>
</head>

<body>
    <div class="app">

        <!-- ── Header ──────────────────────────────────────────── -->
        <header class="header">
            <div class="logo">
                <img class="logo-img" src="logo-192x192.png" alt="Sully logo">
                <div class="logo-word">Sully.ai</div>
                <div class="logo-sep"></div>
                <div class="logo-sub">streaming demo</div>
            </div>
            <div class="header-right">
                <div class="chip" id="wordChip">0 words</div>
                <div class="chip" id="durationChip">00:00</div>
                <div class="status-pill disconnected" id="statusPill">
                    <div class="s-dot"></div>
                    <span id="statusText">disconnected</span>
                </div>
            </div>
        </header>

        <!-- ── Main Grid ─────────────────────────────────────────── -->
        <div class="main-grid">

            <!-- Left -->
            <div class="left-col">

                <!-- Record control -->
                <div class="panel">
                    <div class="record-section">
                        <div class="btn-wrap">
                            <div class="ring" id="ring1"></div>
                            <div class="ring" id="ring2"></div>
                            <button class="rec-btn" id="recBtn">
                                <!-- Mic icon (default) -->
                                <svg id="micIco" class="btn-ico" width="28" height="28" viewBox="0 0 24 24"
                                     fill="none" stroke="currentColor" stroke-width="1.5"
                                     stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="9" y="2" width="6" height="12" rx="3"/>
                                    <path d="M5 10a7 7 0 0 0 14 0"/>
                                    <line x1="12" y1="19" x2="12" y2="22"/>
                                    <line x1="8"  y1="22" x2="16" y2="22"/>
                                </svg>
                                <!-- Stop icon (recording) -->
                                <svg id="stopIco" class="btn-ico" width="28" height="28" viewBox="0 0 24 24"
                                     fill="none" stroke="currentColor" stroke-width="1.5"
                                     stroke-linecap="round" stroke-linejoin="round"
                                     style="display:none">
                                    <rect x="7" y="7" width="10" height="10" rx="2"/>
                                </svg>
                                <span class="btn-lbl" id="btnLbl">record</span>
                            </button>
                        </div>

                        <div class="waveform" id="waveform">
                            <div class="w-bar"></div>
                            <div class="w-bar"></div>
                            <div class="w-bar"></div>
                            <div class="w-bar"></div>
                            <div class="w-bar"></div>
                            <div class="w-bar"></div>
                            <div class="w-bar"></div>
                        </div>

                        <div class="rec-hint" id="recHint">Click to start recording your microphone</div>
                    </div>
                </div>

                <!-- Transcript -->
                <div class="panel" style="flex:1">
                    <div class="panel-head">
                        <div class="panel-tag">
                            <div class="panel-dot" id="txDot"></div>
                            live transcript
                        </div>
                        <div class="panel-info" id="txMeta">—</div>
                    </div>
                    <div class="tx-body" id="txBody">
                        <span class="tx-placeholder" id="txPlaceholder">
                            Transcript will appear here once recording begins...
                        </span>
                    </div>
                </div>

            </div>

            <!-- Right -->
            <div class="right-col">

                <!-- Status History -->
                <div class="panel">
                    <div class="panel-head">
                        <div class="panel-tag">
                            <div class="panel-dot" id="histDot"></div>
                            status history
                        </div>
                        <div class="panel-info" id="histCount">—</div>
                    </div>
                    <div class="history-body" id="histList">
                        <div class="empty-state">No status changes yet</div>
                    </div>
                </div>

                <!-- Event Log -->
                <div class="panel event-panel">
                    <div class="panel-head">
                        <div class="panel-tag">
                            <div class="panel-dot" id="evDot"></div>
                            event log
                        </div>
                        <div class="panel-info" id="evCount">—</div>
                    </div>
                    <div class="event-body" id="evList">
                        <div class="ev-empty">SDK events will appear here</div>
                    </div>
                </div>

            </div>
        </div>

        <!-- ── Footer ──────────────────────────────────────────── -->
        <footer class="footer">
            <span>sully.ai · realtime medical transcription</span>
            <span id="sessionId">—</span>
        </footer>

    </div>

    <script type="module">
        import { SullyStreamingDemo } from './dist/sully-browser-demo.js';

        // ── DOM refs ──────────────────────────────────────────────
        const recBtn   = document.getElementById('recBtn');
        const micIco   = document.getElementById('micIco');
        const stopIco  = document.getElementById('stopIco');
        const btnLbl   = document.getElementById('btnLbl');
        const ring1    = document.getElementById('ring1');
        const ring2    = document.getElementById('ring2');
        const waveform = document.getElementById('waveform');
        const recHint  = document.getElementById('recHint');

        const statusPill = document.getElementById('statusPill');
        const statusText = document.getElementById('statusText');

        const txBody        = document.getElementById('txBody');
        const txPlaceholder = document.getElementById('txPlaceholder');
        const txDot         = document.getElementById('txDot');
        const txMeta        = document.getElementById('txMeta');

        const histList  = document.getElementById('histList');
        const histCount = document.getElementById('histCount');
        const histDot   = document.getElementById('histDot');

        const evList  = document.getElementById('evList');
        const evCount = document.getElementById('evCount');
        const evDot   = document.getElementById('evDot');

        const wordChip     = document.getElementById('wordChip');
        const durationChip = document.getElementById('durationChip');

        // ── State ─────────────────────────────────────────────────
        let isRecording      = false;
        let cursorEl         = null;
        let wordCount        = 0;
        let lastLoggedWords  = -1;
        let historyTotal     = 0;
        let evTotal          = 0;
        let startTime        = null;
        let durationTimer    = null;

        document.getElementById('sessionId').textContent =
            'session:' + Math.random().toString(36).slice(2, 10);

        const STATUS_LABEL = {
            starting:     'initializing',
            connecting:   'connecting',
            connected:    'connected',
            disconnected: 'disconnected',
            error:        'error',
            reconnecting: 'reconnecting',
        };

        function ts() {
            return new Date().toTimeString().slice(0, 8);
        }

        // ── Status pill ───────────────────────────────────────────
        function setStatus(status) {
            statusPill.className = `status-pill ${status}`;
            statusText.textContent = STATUS_LABEL[status] || status;
        }

        // ── History panel — DOM-safe construction ─────────────────
        function pushHistory(status) {
            histList.querySelector('.empty-state')?.remove();

            const row = document.createElement('div');
            row.className = 'h-row';

            const dot = document.createElement('div');
            dot.className = `h-dot ${status}`;

            const label = document.createElement('span');
            label.className = 'h-label';
            label.textContent = STATUS_LABEL[status] || status;

            const time = document.createElement('span');
            time.className = 'h-ts';
            time.textContent = ts();

            row.append(dot, label, time);
            histList.insertBefore(row, histList.firstChild);

            historyTotal++;
            histCount.textContent = `${historyTotal} event${historyTotal !== 1 ? 's' : ''}`;
            histDot.classList.add('on');
        }

        // ── Event log — DOM-safe construction ────────────────────
        // mainText  = prominent text (shown as ev-data-em)
        // asideText = optional dim trailing detail
        function pushEvent(type, mainText, asideText) {
            evList.querySelector('.ev-empty')?.remove();

            const row = document.createElement('div');
            row.className = 'ev-row';

            const head = document.createElement('div');
            head.className = 'ev-head';

            const tag = document.createElement('span');
            tag.className = `ev-tag ${type}`;
            tag.textContent = type;

            const time = document.createElement('span');
            time.className = 'ev-ts';
            time.textContent = ts();

            head.append(tag, time);

            const data = document.createElement('div');
            data.className = 'ev-data';

            const em = document.createElement('span');
            em.className = 'ev-data-em';
            em.textContent = mainText;
            data.appendChild(em);

            if (asideText) {
                const aside = document.createElement('span');
                aside.className = 'ev-data-aside';
                aside.textContent = ' · ' + asideText;
                data.appendChild(aside);
            }

            row.append(head, data);
            evList.appendChild(row);
            evList.scrollTop = evList.scrollHeight;

            evTotal++;
            evCount.textContent = `${evTotal} event${evTotal !== 1 ? 's' : ''}`;
            evDot.classList.add('on');
        }

        // ── Recording state toggle ────────────────────────────────
        function setRecording(on) {
            isRecording = on;

            if (on) {
                recBtn.classList.add('recording');
                ring1.classList.add('pulse');
                ring2.classList.add('pulse');
                waveform.classList.add('on');
                micIco.style.display  = 'none';
                stopIco.style.display = '';
                btnLbl.textContent = 'stop';
                recHint.textContent = 'Recording — click to stop';

                txBody.innerHTML = '';
                cursorEl = document.createElement('span');
                cursorEl.className = 'cursor';
                txBody.appendChild(cursorEl);
                txDot.classList.add('on');
                txMeta.textContent = 'recording…';

                startTime = Date.now();
                durationTimer = setInterval(() => {
                    const s  = Math.floor((Date.now() - startTime) / 1000);
                    const mm = String(Math.floor(s / 60)).padStart(2, '0');
                    const ss = String(s % 60).padStart(2, '0');
                    durationChip.textContent = `${mm}:${ss}`;
                    durationChip.classList.add('live');
                }, 1000);

                wordChip.classList.add('live');

            } else {
                recBtn.classList.remove('recording');
                ring1.classList.remove('pulse');
                ring2.classList.remove('pulse');
                waveform.classList.remove('on');
                micIco.style.display  = '';
                stopIco.style.display = 'none';
                btnLbl.textContent = 'record';
                recHint.textContent = 'Click to start recording your microphone';
                txDot.classList.remove('on');

                if (cursorEl?.parentNode) {
                    cursorEl.parentNode.removeChild(cursorEl);
                    cursorEl = null;
                }

                if (!txBody.textContent.trim()) {
                    txBody.textContent = '';
                    txBody.appendChild(txPlaceholder);
                }

                txMeta.textContent = wordCount > 0 ? `${wordCount} words` : '—';

                clearInterval(durationTimer);
                durationTimer = null;
            }
        }

        // ── SDK ───────────────────────────────────────────────────
        const demo = new SullyStreamingDemo({
            onTranscription: (text) => {
                if (cursorEl?.parentNode) cursorEl.parentNode.removeChild(cursorEl);
                txBody.textContent = text;
                if (cursorEl) txBody.appendChild(cursorEl);

                wordCount = text.trim().split(/\s+/).filter(Boolean).length;
                wordChip.textContent = `${wordCount} words`;
                txMeta.textContent   = `${wordCount} words`;

                // Log only when new words are recognised (avoids flooding)
                if (wordCount !== lastLoggedWords) {
                    lastLoggedWords = wordCount;
                    const preview = text.length > 72 ? text.slice(0, 72) + '…' : text;
                    pushEvent('TRANSCRIPT', `"${preview}"`, `${wordCount}w`);
                }
            },

            onError: (error) => {
                pushEvent('ERROR', error.message);
                setStatus('error');
                setRecording(false);
            },

            onComplete: () => {
                pushEvent('COMPLETE', 'Stream ended cleanly');
                setRecording(false);
            },

            onStatusChange: (status) => {
                setStatus(status);
                pushHistory(status);
                pushEvent('STATUS', STATUS_LABEL[status] || status);
            },
        });

        // ── Button ────────────────────────────────────────────────
        recBtn.onclick = async () => {
            if (!isRecording) {
                wordCount       = 0;
                lastLoggedWords = -1;
                wordChip.textContent = '0 words';
                setRecording(true);
                await demo.start();
            } else {
                demo.stop();
                setRecording(false);
            }
        };

        // ── Init ──────────────────────────────────────────────────
        setStatus('disconnected');
    </script>
</body>
</html>
